name: Deploy Markdown as HTML to GitHub Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pandoc csplit

      - name: Build site from CONTRIBUTING.md
        run: |
          set -e
          mkdir -p site/articles

          echo "=== Découpage de CONTRIBUTING.md en articles ==="
          # Supprime d'éventuels anciens fichiers temporaires
          rm -f xx* 
          # Découpe par séparateur "---"
          csplit -s CONTRIBUTING.md '/^---$/' '{*}'

          # Boucle sur chaque article découpé
          for f in xx*; do
            # Récupère le titre et slug
            title=$(head -1 "$f" | sed 's/^# //')
            slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            # Récupère la date
            date=$(grep "^### Date" "$f" | sed 's/^### Date : //')

            echo "→ Conversion : $title → site/articles/${slug}.html"
            pandoc "$f" \
              --from markdown \
              --to html5 \
              --standalone \
              --template=templates/page.html \
              --metadata title="$title" \
              --metadata date="$date" \
              --output "site/articles/${slug}.html"
          done

          echo "=== Génération de l'index ==="
          echo "# Accueil" > /tmp/index.md
          echo "" >> /tmp/index.md
          echo "## Liste des articles" >> /tmp/index.md
          echo "" >> /tmp/index.md

          # Crée la liste des articles pour l'index
          for html in site/articles/*.html; do
            filename=$(basename "$html" .html)
            title=$(grep "<h1>" "$html" | sed 's/<[^>]*>//g')
            date=$(grep "<em>" "$html" | sed 's/<[^>]*>//g')
            echo "- [$title](/articles/${filename}.html) — $date" >> /tmp/index.md
          done

          # Convertit l'index en HTML
          pandoc /tmp/index.md \
            --from markdown \
            --to html5 \
            --standalone \
            --template=templates/page.html \
            --metadata title="Accueil" \
            --output site/index.html

          echo "=== Contenu généré ==="
          find site -type f -print
          du -sh site

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
