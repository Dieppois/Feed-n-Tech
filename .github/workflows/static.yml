name: Build and Deploy Feed-n-Tech Blog

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ------------------------
  # 1Ô∏è‚É£ BUILD & ACTIVATE
  # ------------------------
  build:
    name: Build site
    runs-on: ubuntu-latest
    outputs:
      site-path: ${{ steps.output_path.outputs.path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pandoc coreutils

      - name: Build site from CONTRIBUTING.md
        id: build_site
        run: |
          set -e
          rm -rf site xx*
          mkdir -p site/articles

          echo "=== D√©coupage de CONTRIBUTING.md en articles ==="
          csplit -s CONTRIBUTING.md '/^---$/' '{*}'

          declare -a articles=()

          for f in xx*; do
            title=$(head -1 "$f" | sed 's/^# //')
            date=$(grep "^### Date" "$f" | sed 's/^### Date : //')

            if [ -z "$title" ] || [ -z "$date" ]; then
              echo "‚ö†Ô∏è Article ignor√© (titre ou date manquant) : $f"
              rm -f "$f"
              continue
            fi

            slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            echo "‚Üí G√©n√©ration : $title ‚Üí site/articles/${slug}.html"

            pandoc "$f" \
              --from markdown \
              --to html5 \
              --standalone \
              --template=templates/page.html \
              --metadata title="$title" \
              --metadata date="$date" \
              --output "site/articles/${slug}.html"

            articles+=("$date;$title;$slug")
          done

          echo "=== G√©n√©ration de l'index.html ==="
          IFS=$'\n' sorted=($(sort -r <<<"${articles[*]}"))
          unset IFS

          echo "# Accueil" > /tmp/index.md
          echo "" >> /tmp/index.md
          echo "## Liste des articles" >> /tmp/index.md
          echo "" >> /tmp/index.md

          for line in "${sorted[@]}"; do
            IFS=';' read -r date title slug <<< "$line"
            echo "- [$title](/Feed-n-Tech/articles/${slug}.html) ‚Äî $date" >> /tmp/index.md
          done

          pandoc /tmp/index.md \
            --from markdown \
            --to html5 \
            --standalone \
            --template=templates/page.html \
            --metadata title="Accueil" \
            --output site/index.html

          echo "=== Contenu g√©n√©r√© ==="
          find site -type f -print
          du -sh site

      - name: Save output path
        id: output_path
        run: echo "path=site" >> $GITHUB_OUTPUT

  # ------------------------
  # 2Ô∏è‚É£ DEPLOYMENT
  # ------------------------
  deploy:
    name: Deploy to GitHub Pages
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ needs.build.outputs.site-path }}

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

  # ------------------------
  # 3Ô∏è‚É£ SMOKE TEST
  # ------------------------
  smoke-test:
    name: Smoke test deployment
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for site to be available
        run: |
          echo "‚è≥ Attente du d√©ploiement de la page..."
          sleep 10
      - name: Test site availability
        run: |
          URL="https://dieppois.github.io/Feed-n-Tech/"
          echo "üîç V√©rification de $URL"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$URL")
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå Site non accessible (HTTP $STATUS)"
            exit 1
          fi
          echo "‚úÖ Site accessible avec succ√®s (HTTP $STATUS)"
