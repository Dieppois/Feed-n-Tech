name: Deploy Markdown as HTML to GitHub Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pandoc

      - name: Build static site
        run: |
          set -e
          mkdir -p site/articles

          echo "=== Conversion des fichiers Markdown en HTML ==="
          for md in $(find articles -name '*.md' | sort); do
            slug=$(basename "$md" .md)
            title=$(sed -n '1,20p' "$md" | sed -n 's/^#\s*Titre\s*:\s*//Ip')
            date=$(sed -n '1,20p' "$md" | sed -n 's/^###\s*Date\s*:\s*//Ip')
            [ -z "$title" ] && title="$slug"

            echo "→ Conversion de $md en site/articles/${slug}.html (titre=$title)"
            pandoc "$md" \
              --from markdown \
              --to html5 \
              --standalone \
              --template=templates/page.html \
              --metadata title="$title" \
              --metadata date="$date" \
              --output "site/articles/${slug}.html"
          done

          echo "=== Génération de la page d'accueil ==="
          echo "# Accueil" > /tmp/index.md
          echo "" >> /tmp/index.md
          echo "## Liste des articles" >> /tmp/index.md
          echo "" >> /tmp/index.md

          find articles -name '*.md' | while read mdfile; do
            slug=$(basename "$mdfile" .md)
            title=$(sed -n '1,20p' "$mdfile" | sed -n 's/^#\s*Titre\s*:\s*//Ip')
            date=$(sed -n '1,20p' "$mdfile" | sed -n 's/^###\s*Date\s*:\s*//Ip')
            [ -z "$title" ] && title="$slug"
            if [ -z "$date" ]; then
              echo "- [$title](/articles/${slug}.html)" >> /tmp/index.md
            else
              echo "- [$title](/articles/${slug}.html) — $date" >> /tmp/index.md
            fi
          done

          pandoc /tmp/index.md \
            --from markdown \
            --to html5 \
            --standalone \
            --template=templates/page.html \
            --metadata title="Accueil" \
            --output site/index.html

          echo "=== Contenu généré ==="
          find site -type f -print
          du -sh site

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
