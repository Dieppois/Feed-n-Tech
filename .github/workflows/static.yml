name: Deploy Markdown as HTML to GitHub Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pandoc csplit

      - name: Build site from CONTRIBUTING.md
        run: |
          set -e

          # Nettoyer ancien build
          rm -rf site xx*
          mkdir -p site/articles

          echo "=== Découpage de CONTRIBUTING.md en articles ==="
          csplit -s CONTRIBUTING.md '/^---$/' '{*}'

          declare -a articles=()

          # Génération des pages articles
          for f in xx*; do
            title=$(head -1 "$f" | sed 's/^# //')
            date=$(grep "^### Date" "$f" | sed 's/^### Date : //')

            if [ -z "$title" ] || [ -z "$date" ]; then
              echo "⚠️ Article ignoré (titre ou date manquant) : $f"
              rm -f "$f"
              continue
            fi

            slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

            echo "→ Génération : $title → site/articles/${slug}.html"
            pandoc "$f" \
              --from markdown \
              --to html5 \
              --standalone \
              --template=templates/page.html \
              --metadata title="$title" \
              --metadata date="$date" \
              --output "site/articles/${slug}.html"

            articles+=("$date;$title;$slug")
          done

          echo "=== Génération de l'index.html ==="
          IFS=$'\n' sorted=($(sort -r <<<"${articles[*]}"))
          unset IFS

          echo "# Accueil" > /tmp/index.md
          echo "" >> /tmp/index.md
          echo "## Liste des articles" >> /tmp/index.md
          echo "" >> /tmp/index.md

          for line in "${sorted[@]}"; do
            IFS=';' read -r date title slug <<< "$line"
            echo "- [$title](/Feed-n-Tech/articles/${slug}.html) — $date" >> /tmp/index.md
          done

          pandoc /tmp/index.md \
            --from markdown \
            --to html5 \
            --standalone \
            --template=templates/page.html \
            --metadata title="Accueil" \
            --output site/index.html

          echo "=== Contenu généré ==="
          find site -type f -print
          du -sh site

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
